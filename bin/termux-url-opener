#!/data/data/com.termux/files/usr/bin/bash

# Config

STORAGE="$HOME/storage"
MUSIC="$STORAGE/music"
ASMR="$STORAGE/shared/.nsfw"
VIDEOS="$STORAGE/movies"
CLIPS="$STORAGE/movies/Clips"
DOWNLOADS="$STORAGE/downloads"

# End

url=$1

echo $url

# Site regexs
yt="^(https?\:\/\/)?(((www|m)\.)?youtube\.com|youtu\.be)\/.+$"

# Functions for downloading 

ytdl() {
  yt-dlp $url --external-downloader-args "aria2c: -x 16  -k 10M" "${@}"
}

asmr() {
  echo ASMR
  ytdl -f bestaudio --extract-audio --embed-thumbnail --embed-metadata \
    -o "$ASMR/yt/%(channel)s/%(upload_date)s-%(title).150B-%(id)s.%(ext)s" --no-mtime $url
}

music() {
  echo Music
  ytdl -f bestaudio --extract-audio --embed-thumbnail --embed-metadata \
    --postprocessor-args "-filter:v crop=in_h" \
    -o "$MUSIC/%(title)s.%(ext)s" --no-mtime
}

video() {
  echo Video
  ytdl -f 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/mp4' \
    -o "$VIDEOS/%(title)s-%(id)s.%(ext)s" \
    --embed-subs --embed-thumbnail --embed-metadata \
    -S res,hdr,fps,vcodec:av01:h265:vp9.2:vp9:h264,vbr \
    --no-mtime
}

aria() {
  aria2c -x16 -d $DOWNLOADS \
    --on-download-complete "$HOME/bin/openfile" \
    $url
  exit
}

spot() {
  spotdl $url --output $MUSIC
  exit
}

play_audio() {
  mpv --no-video $url
  exit
}

yt() {
  method="$(termux-dialog sheet -v "ASMR,Music,Video,Play in mpv" | jq '.index' -r)"
  case $method in
  0)
    asmr
  ;;
  1)
    music
  ;;
  2)
    video
  ;;
  3)
    play_audio
  ;;
  *)
    exit
  ;;
  esac
}

uns() {
  method="$(termux-dialog sheet -v "Music,Video,Aria" | jq '.index' -r)"
  case $method in
  0)
    music
    ;;
  1)
    video
    ;;
  2)
    aria
    ;;
  esac
}

# Enable extglob for regex
shopt -s extglob

# Check what site is being passed
case $url in
https://music.youtube.com/watch?v=+([a-zA-Z0-9_-])*)
  music
;;
*youtube.com* | *youtu.be*)
  echo Download a yt vid
  yt
;;
*twitter*)
  echo twitter
  video
;;
*sourceforge* | *zippyshare* | *github*)
  echo download file
  aria
;;
*spotify*)
  spot
;;
*)
  echo "unsupported site"
  uns
;;
esac

exit
termux-toast -s "Download Done"
