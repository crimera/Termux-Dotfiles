#!/data/data/com.termux/files/usr/bin/bash

# Config

STORAGE="$HOME/storage"
MUSIC="$STORAGE/music"
ASMR="$STORAGE/shared/.nsfw"
VIDEOS="$STORAGE/movies"
CLIPS="$STORAGE/movies/Clips"
DOWNLOADS="$STORAGE/downloads"

# End

url=$1

echo $url

# Enable extglob for regex
shopt -s extglob
# Returns the first error on a pipe
set -o pipefail

# Site regexs
yt="^(https?\:\/\/)?(((www|m)\.)?youtube\.com|youtu\.be)\/.+$"

# utils

notify() {
  path="$(ls "$1"*)"
  thumb="${path%.*}.jpg"
  termux-notification --action "termux-open \"$path\"" -c "Download complete" -t "$(basename "$1")" --icon "done" --image-path "$thumb"
  rm "$thumb"
}

# Functions for downloading
ytdl() {
  ytout=$(yt-dlp "$url" -N 4 --convert-thumbnails jpg --no-mtime --exec after_move:'echo "%(filepath)s"' --write-thumbnail --external-downloader aria2c --downloader-args aria2c:'-x16 --continue' "$@" | tee /dev/tty)
  status=$?

  filename="$(tail -n 1 <<< "$ytout")"
  
  if [ "$status" -eq 0 ]; then
    notify "$filename"
  else
    echo "$status" > code.txt
  fi
}

asmr() {
  echo ASMR
  ytdl -o "$ASMR/yt/%(channel)s/%(upload_date)s-%(title).150B-%(id)s.%(ext)s" \
    -x --embed-thumbnail --embed-metadata
}

music() {
  echo Music
  ytdl -x --embed-thumbnail --embed-metadata \
    -o "$MUSIC/%(title)s.%(ext)s" \
    --postprocessor-args "ffmpeg:-filter:v crop=in_h"
}

video() {
  echo Video
  ytdl -f "best[ext=mp4]" \
    -o "$VIDEOS/%(title)s-%(id)s.%(ext)s" \
    --embed-subs --embed-thumbnail
}

aria() {
  out=$(aria2c -x16 -d $DOWNLOADS \
    --on-download-complete "$HOME/bin/openfile" \
    --continue \
    "$url")
}

spot() {
  spotdl "$url" --output $MUSIC
}

play_audio() {
  mpv --no-video "$url"
}

yt() {
  method="$(termux-dialog sheet -v "ASMR,Music,Video,Play in mpv" | jq '.index' -r)"
  case $method in
  0)
    asmr
  ;;
  1)
    music
  ;;
  2)
    video
  ;;
  3)
    play_audio
  ;;
  *)
    exit
  ;;
  esac
}

uns() {
  method="$(termux-dialog sheet -v "Music,Video,Aria" | jq '.index' -r)"
  case $method in
  0)
    music
    ;;
  1)
    video
    ;;
  2)
    aria
    ;;
  esac
}

# Check what site is being passed
case "$url" in
https://music.youtube.com/watch?v=+([a-zA-Z0-9_-])*)
  music
;;
*youtube.com* | *youtu.be*)
  echo Download a yt vid
  yt
;;
*twitter*)
  echo twitter
  video
;;
*sourceforge* | *zippyshare* | *github*)
  echo download file
  aria
;;
*spotify*)
  spot
;;
*)
  echo "unsupported site"
  uns
;;
esac

termux-toast -s "Download Done"
