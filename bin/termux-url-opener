#!/data/data/com.termux/files/usr/bin/bash

# Config

STORAGE="$HOME/storage"
MUSIC="$STORAGE/music"
ASMR="$STORAGE/shared/.nsfw"
VIDEOS="$STORAGE/movies"
CLIPS="$STORAGE/movies/Clips"
DOWNLOADS="$STORAGE/downloads"

# End

url=$1

echo $url

# Enable extglob for regex
shopt -s extglob
# Returns the first error on a pipe
set -o pipefail

# Site regexs
yt="^(https?\:\/\/)?(((www|m)\.)?youtube\.com|youtu\.be)\/.+$"

# Functions for downloading 

ytdl() {
  ytout=$(yt-dlp "$url" --convert-thumbnails jpg --no-mtime "$@" | tee /dev/tty)
  status=$?
  echo status: $status

  match="\"$STORAGE"
  out=$( grep $match <<< ${ytout} | head -n 1 )
  filepath=${out#*'"'}; filepath=${filepath%'"'*}
  filename=${filepath%.*}
 
  echo "$filename"
  if [[ $status != 0 ]]; then
    rm "$filename.jpg"
  fi

  path="$(ls "$filename"*)"
  termux-notification --action "termux-open \"$path\"" -c "click to open" -t "Downloaded: $(basename "$filename")" --icon "download_done"
}

asmr() {
  echo ASMR
  ytdl -o "$ASMR/yt/%(channel)s/%(upload_date)s-%(title).150B-%(id)s.%(ext)s" \
    -x --embed-thumbnail --embed-metadata
}

music() {
  echo Music
  ytdl -x --embed-thumbnail --embed-metadata \
    -o "$MUSIC/%(title)s.%(ext)s" \
    --postprocessor-args "ffmpeg:-filter:v crop=in_h"
}

video() {
  echo Video
  ytdl -f "best[ext=mp4]" \
    -o "$VIDEOS/%(title)s-%(id)s.%(ext)s" \
    --embed-subs --embed-thumbnail
}

aria() {
  aria2c -x16 -d $DOWNLOADS \
    --on-download-complete "$HOME/bin/openfile" \
    "$url"
}

spot() {
  spotdl "$url" --output $MUSIC
}

play_audio() {
  mpv --no-video "$url"
}

yt() {
  method="$(termux-dialog sheet -v "ASMR,Music,Video,Play in mpv" | jq '.index' -r)"
  case $method in
  0)
    asmr
  ;;
  1)
    music
  ;;
  2)
    video
  ;;
  3)
    play_audio
  ;;
  *)
    exit
  ;;
  esac
}

uns() {
  method="$(termux-dialog sheet -v "Music,Video,Aria" | jq '.index' -r)"
  case $method in
  0)
    music
    ;;
  1)
    video
    ;;
  2)
    aria
    ;;
  esac
}

# Check what site is being passed
case "$url" in
https://music.youtube.com/watch?v=+([a-zA-Z0-9_-])*)
  music
;;
*youtube.com* | *youtu.be*)
  echo Download a yt vid
  yt
;;
*twitter*)
  echo twitter
  video
;;
*sourceforge* | *zippyshare* | *github*)
  echo download file
  aria
;;
*spotify*)
  spot
;;
*)
  echo "unsupported site"
  uns
;;
esac

termux-toast -s "Download Done"
